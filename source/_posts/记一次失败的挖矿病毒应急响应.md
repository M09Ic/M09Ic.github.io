---
title: 记一次失败的挖矿病毒应急响应
abbrlink: 35826
date: 2019-05-12 19:15:10
categories: 其他
tags:
  - 应急响应
  - windows

---

## 0x00 前言

一个小伙伴的朋友说自己家里的windows server 2008 R2 服务中了挖矿木马让我看看.

服务上只装了个mssql 2008 和 管家婆ERP3 ,通过花生壳88端口映射到公网.

服务器刚装好,只在公网开了三天,5月8日发现mssql 2008 上不去了,才发现中了挖矿木马.

总共花了五六个小时,只能勉强分析出攻击情况,无法彻底清理干净.但是挺好玩的,大概是在两个不同的木马在掐架.

## 0x01 粗略分析

我接手的时候,他说已经删了两个木马文件.但是重启后这两个木马文件没再次生成,服务还是有一个高cpu占用的进程`lsmm.exe`.

![1](1.png)

所以没截图,这图是在下面链接里的文章偷的,只能文字描述一下两个木马创建时间是在5月5日12点左右,也是在这个文件夹下面.

lacas.exe是矿机,lsass.exe是矿机的释放程序,也是本地安全认证子系统服务（Local Security Authority Subsystem Servic),和系统重要进程同名混淆一下,但是cpu占用高,一眼就能看穿了.

通过lacas.exe这个文件名在网上搜索到了腾讯安全的这篇文章:

[挖矿木马针对SQL服务器爆破攻击 中招可致服务器被远程控制](<https://s.tencent.com/research/report/684.html>)

浏览了下文章,大致知道是mssql弱密码爆破进来的.

那就先看一下安全日志.

![2](2.png)

确实找到了很多爆破记录,这里说一下mssql登录失败的事件id是`18456`.

*注.这次分析用到的一些工具和操作都写在另外一篇文章:{% post_link windows-server-应急响应查表 %}里.*

这样基本可以确定挖矿木马就是这样了,腾讯的文章分析很全面,照着步骤一步一步删除服务,启动项,计划任务,文件之类的就好了.

**等等!没这么快.**

矿机肯定注册的服务,那就在日志里筛选事件id为`7045`(创建服务)的日志,果然发现了一条.

![3](3.png)

嗯,很简单,打开`services.msc,`找到`DiagHnostion Windows Host`删除即可.

用`SysinternalsSuite`工具包中的`Autoruns.exe`搜索一下

[SysinternalsSuite下载](<https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite>)

![4](4.png)

空的,没有这个服务.

网上没找到删除服务的事件id.自己测试了下删除启动项和服务也没有日志记录,如果有求告知.

但是挖矿木马确确实实还是存在的,只是换了个名字.

![5](5.png)



## 0x02 相爱相杀

突然没有了头绪.只能继续审计日志.

找到了一些比较奇怪的操作记录,没有一一截图.

![6](6.png)

![7](7.png)

创建了一个账号,又很快删除了.还有一些服务创建失败的记录(事件id:7030)

直接通过进程反查到文件`msinfo.exe`

又继续看了一下启动项,网络,文件之类的.

没写完,明天再写,反正没人看,当草稿发布了.